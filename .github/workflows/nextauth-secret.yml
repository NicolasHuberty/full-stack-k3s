name: Deploy NEXTAUTH_SECRET to Vault

on:
  push:
    branches: [main]
    paths:
      - '.github/workflows/nextauth-secret.yml'
  workflow_dispatch:

jobs:
  write-secret:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Vault CLI
        run: |
          curl -L -o vault.zip https://releases.hashicorp.com/vault/1.15.4/vault_1.15.4_linux_amd64.zip
          unzip vault.zip -d /usr/local/bin
          chmod +x /usr/local/bin/vault

      - name: Authenticate to Vault
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          VAULT_TOKEN: ${{ secrets.VAULT_ROOT_TOKEN }}
        run: |
          vault login $VAULT_TOKEN

      - name: Generate NEXTAUTH_SECRET
        id: gen_secret
        run: |
          SECRET=$(openssl rand -base64 32)
          echo "secret=$SECRET" >> $GITHUB_OUTPUT

      - name: Write NEXTAUTH_SECRET to Vault
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
        run: |
          vault kv put secret/docularis/production nextauth_secret="${{ steps.gen_secret.outputs.secret }}"
